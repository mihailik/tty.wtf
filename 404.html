<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TTY</title>
<style>
html {
  box-sizing: border-box;
  width: 100%; height: 100%;
  overflow: hidden;
  padding: 0; margin: 0;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  width: 100%; height: 100%;
  overflow: hidden;
  padding: 0; margin: 0;
}
*, *:before, *:after {
  box-sizing: inherit;
}

#toolbar {
  position: absolute;
  top: 0; left: 0; width: 100%;
  background-image: linear-gradient(to top, #fff6f6, white 1em);
  border-bottom: solid 1px #ffe6e6;
  padding-left: 0.3em;
}

#toolbar button {
  width: 2.7em; height: 2.7em; margin: 0.15em;
}

#textarea {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  overflow: auto;
  border: none;
  padding: 1em;
  outline: none;
  font: inherit;
  padding-top: 4em;
}

</style>
</head>
<body>
<textarea id="textarea" autofocus>
</textarea>
<div id="toolbar">
<button id="bold">ğ—•</button>
<button id="italic">ğ˜</button>
<button id="fractur">ğ•±</button>
<button id="cursive">ğ“’</button>
<button id="upper">áµ</button>
<button id="squareBox">ğŸ…‚</button>
<button id="squareFill">ğŸ†€</button>
<button id="round">â“‡</button>
<button id="typewrighter">ğšƒ</button>
<button id="wide">ğ•</button>

<div id="status" style="
  position: absolute;
  right: 1em;
  top: 0;"></div>
</div>
<script>
// @ts-check

function load() {

  var variants = {
    bold: {AZ: ('ğ—”,ğ—•,ğ—–,ğ——,ğ—˜,ğ—™,ğ—š,ğ—›,ğ—œ,ğ—,ğ—,ğ—Ÿ,ğ— ,ğ—¡,ğ—¢,ğ—£,ğ—¤,ğ—¥,ğ—¦,ğ—§,ğ—¨,ğ—©,ğ—ª,ğ—«,ğ—¬,ğ—­').split(','), az: ('ğ—®,ğ—¯,ğ—°,ğ—±,ğ—²,ğ—³,ğ—´,ğ—µ,ğ—¶,ğ—·,ğ—¸,ğ—¹,ğ—º,ğ—»,ğ—¼,ğ—½,ğ—¾,ğ—¿,ğ˜€,ğ˜,ğ˜‚,ğ˜ƒ,ğ˜„,ğ˜…,ğ˜†,ğ˜‡').split(','), '09': ('ğŸ¬,ğŸ­,ğŸ®,ğŸ¯,ğŸ°,ğŸ±,ğŸ²,ğŸ³,ğŸ´,ğŸµ').split(',')},
    italic: {AZ: ('ğ˜ˆ,ğ˜‰,ğ˜Š,ğ˜‹,ğ˜Œ,ğ˜,ğ˜,ğ˜,ğ˜,ğ˜‘,ğ˜’,ğ˜“,ğ˜”,ğ˜•,ğ˜–,ğ˜—,ğ˜˜,ğ˜™,ğ˜š,ğ˜›,ğ˜œ,ğ˜,ğ˜,ğ˜Ÿ,ğ˜ ,ğ˜¡').split(','), az:('ğ˜¢,ğ˜£,ğ˜¤,ğ˜¥,ğ˜¦,ğ˜§,ğ˜¨,ğ˜©,ğ˜ª,ğ˜«,ğ˜¬,ğ˜­,ğ˜®,ğ˜¯,ğ˜°,ğ˜±,ğ˜²,ğ˜³,ğ˜´,ğ˜µ,ğ˜¶,ğ˜·,ğ˜¸,ğ˜¹,ğ˜º,ğ˜»').split(',')},
    bolditalic: {AZ: ['ğ˜¼','ğ˜½','ğ˜¾','ğ˜¿','ğ™€','ğ™','ğ™‚','ğ™ƒ','ğ™„','ğ™…','ğ™†','ğ™‡','ğ™ˆ','ğ™‰','ğ™Š','ğ™‹','ğ™Œ','ğ™','ğ™','ğ™','ğ™','ğ™‘','ğ™’','ğ™“','ğ™”','ğ™•'], az: ['ğ™–','ğ™—','ğ™˜','ğ™™','ğ™š','ğ™›','ğ™œ','ğ™','ğ™','ğ™Ÿ','ğ™ ','ğ™¡','ğ™¢','ğ™£','ğ™¤','ğ™¥','ğ™¦','ğ™§','ğ™¨','ğ™©','ğ™ª','ğ™«','ğ™¬','ğ™­','ğ™®','ğ™¯']},
    fractur: {AZ: ['ğ”„','ğ”…','â„­','ğ”‡','ğ”ˆ','ğ”‰','ğ”Š','â„Œ','â„‘','ğ”','ğ”','ğ”','ğ”','ğ”‘','ğ”’','ğ”“','ğ””','â„œ','ğ”–','ğ”—','ğ”˜','ğ”™','ğ”š','ğ”›','ğ”œ','â„¨'], az: ['ğ”','ğ”Ÿ','ğ” ','ğ”¡','ğ”¢','ğ”£','ğ”¤','ğ”¥','ğ”¦','ğ”§','ğ”¨','ğ”©','ğ”ª','ğ”«','ğ”¬','ğ”­','ğ”®','ğ”¯','ğ”°','ğ”±','ğ”²','ğ”³','ğ”´','ğ”µ','ğ”¶','ğ”·']},
    boldfractur: {AZ: ['ğ•¬','ğ•­','ğ•®','ğ•¯','ğ•°','ğ•±','ğ•²','ğ•³','ğ•´','ğ•µ','ğ•¶','ğ•·','ğ•¸','ğ•¹','ğ•º','ğ•»','ğ•¼','ğ•½','ğ•¾','ğ•¿','ğ–€','ğ–','ğ–‚','ğ–ƒ','ğ–„','ğ–…'], az:['ğ–†','ğ–‡','ğ–ˆ','ğ–‰','ğ–Š','ğ–‹','ğ–Œ','ğ–','ğ–','ğ–','ğ–','ğ–‘','ğ–’','ğ–“','ğ–”','ğ–•','ğ––','ğ–—','ğ–˜','ğ–™','ğ–š','ğ–›','ğ–œ','ğ–','ğ–','ğ–Ÿ']},
    cursive: {AZ:['ğ’œ','ğµ','ğ’','ğ’Ÿ','ğ¸','ğ¹','ğ’¢','ğ»','ğ¼','ğ’¥','ğ’¦','ğ¿','ğ‘€','ğ’©','ğ’ª','ğ’«','ğ’¬','ğ‘…','ğ’®','ğ’¯','ğ’°','ğ’±','ğ’²','ğ’³','ğ’´','ğ’µ'], az: ['ğ’¶','ğ’·','ğ’¸','ğ’¹','ğ‘’','ğ’»','ğ‘”','ğ’½','ğ’¾','ğ’¿','ğ“€','ğ“','ğ“‚','ğ“ƒ','ğ‘œ','ğ“…','ğ“†','ğ“‡','ğ“ˆ','ğ“‰','ğ“Š','ğ“‹','ğ“Œ','ğ“','ğ“','ğ“']},
    boldcursive: {AZ:['ğ“','ğ“‘','ğ“’','ğ““','ğ“”','ğ“•','ğ“–','ğ“—','ğ“˜','ğ“™','ğ“š','ğ“›','ğ“œ','ğ“','ğ“','ğ“Ÿ','ğ“ ','ğ“¡','ğ“¢','ğ“£','ğ“¤','ğ“¥','ğ“¦','ğ“§','ğ“¨','ğ“©'], az: ['ğ“ª','ğ“«','ğ“¬','ğ“­','ğ“®','ğ“¯','ğ“°','ğ“±','ğ“²','ğ“³','ğ“´','ğ“µ','ğ“¶','ğ“·','ğ“¸','ğ“¹','ğ“º','ğ“»','ğ“¼','ğ“½','ğ“¾','ğ“¿','ğ”€','ğ”','ğ”‚','ğ”ƒ']},
    upper: {AZ: ['á´¬','á´®','á¶œ','á´°','á´±','á¶ ','á´³','á´´','á´µ','á´¶','á´·','á´¸','á´¹','á´º','á´¼','á´¾','á´¼Ì´','á´¿','Ë¢','áµ€','áµ','â±½','áµ‚','Ë£','Ê¸','á¶»'], az: ['áµƒ','áµ‡','á¶œ','áµˆ','áµ‰','á¶ ','áµ','Ê°','â±','Ê²','áµ','Ë¡','áµ','â¿','áµ’','áµ–','Ù©','Ê³','Ë¢','áµ—','áµ˜','áµ›','Ê·','Ë£','Ê¸','á¶»'], '09': ['â°','Â¹','Â²','Â³','â´','âµ','â¶','â·','â¸','â¹']},
    squareBox: {AZ: ['ğŸ„°','ğŸ„±','ğŸ„²','ğŸ„³','ğŸ„´','ğŸ„µ','ğŸ„¶','ğŸ„·','ğŸ„¸','ğŸ„¹','ğŸ„º','ğŸ„»','ğŸ„¼','ğŸ„½','ğŸ„¾','ğŸ„¿','ğŸ…€','ğŸ…','ğŸ…‚','ğŸ…ƒ','ğŸ…„','ğŸ……','ğŸ…†','ğŸ…‡','ğŸ…ˆ','ğŸ…‰']},
    squareFill: {AP: ['ğŸ…°','ğŸ…±','ğŸ…²','ğŸ…³','ğŸ…´','ğŸ…µ','ğŸ…¶','ğŸ…·','ğŸ…¸','ğŸ…¹','ğŸ…º','ğŸ…»','ğŸ…¼','ğŸ…½','ğŸ…¾','ğŸ…¿','ğŸ†€','ğŸ†','ğŸ†‚','ğŸ†ƒ','ğŸ†„','ğŸ†…','ğŸ††','ğŸ†‡','ğŸ†ˆ','ğŸ†‰']},
    round: {AZ:['â’¶','â’·','â’¸','â’¹','â’º','â’»','â’¼','â’½','â’¾','â’¿','â“€','â“','â“‚','â“ƒ','â“„','â“…','â“†','â“‡','â“ˆ','â“‰','â“Š','â“‹','â“Œ','â“','â“','â“'], az: ['â“','â“‘','â“’','â““','â“”','â“•','â“–','â“—','â“˜','â“™','â“š','â“›','â“œ','â“','â“','â“Ÿ','â“ ','â“¡','â“¢','â“£','â“¤','â“¥','â“¦','â“§','â“¨','â“©'], '09': ['â“ª','â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨']},
    typewriter: {AZ:['ğ™°','ğ™±','ğ™²','ğ™³','ğ™´','ğ™µ','ğ™¶','ğ™·','ğ™¸','ğ™¹','ğ™º','ğ™»','ğ™¼','ğ™½','ğ™¾','ğ™¿','ğš€','ğš','ğš‚','ğšƒ','ğš„','ğš…','ğš†','ğš‡','ğšˆ','ğš‰'], az: ['ğšŠ','ğš‹','ğšŒ','ğš','ğš','ğš','ğš','ğš‘','ğš’','ğš“','ğš”','ğš•','ğš–','ğš—','ğš˜','ğš™','ğšš','ğš›','ğšœ','ğš','ğš','ğšŸ','ğš ','ğš¡','ğš¢','ğš£'], '09': ['ğŸ¶','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¼','ğŸ½','ğŸ¾','ğŸ¿']},
    wide: {AZ: ['ğ”¸','ğ”¹','â„‚','ğ”»','ğ”¼','ğ”½','ğ”¾','â„','ğ•€','ğ•','ğ•‚','ğ•ƒ','ğ•„','â„•','ğ•†','â„™','â„š','â„','ğ•Š','ğ•‹','ğ•Œ','ğ•','ğ•','ğ•','ğ•','â„¤'], az: ['ğ•’','ğ•“','ğ•”','ğ••','ğ•–','ğ•—','ğ•˜','ğ•™','ğ•š','ğ•›','ğ•œ','ğ•','ğ•','ğ•Ÿ','ğ• ','ğ•¡','ğ•¢','ğ•£','ğ•¤','ğ•¥','ğ•¦','ğ•§','ğ•¨','ğ•©','ğ•ª','ğ•«'], '09': ['ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ','ğŸŸ','ğŸ ','ğŸ¡']}
  };

  var save_timeout;
  var selection_timeout;
  
  var textarea = /** @type {HTMLTextAreaElement} */(document.getElementById('textarea'));
  textarea.value = getStorageText();

  var status = document.getElementById('status');

  textarea.onchange = textarea_onchange;
  textarea.onselect = textarea_onselectionchange;
  textarea.onselectionchange = textarea_onselectionchange;
  textarea.onselectstart = textarea_onselectionchange;
  textarea.onkeydown = textarea_onselectionchange;
  textarea.onkeyup = textarea_onselectionchange;
  textarea.onmousedown = textarea_onselectionchange;

  window.onunload = window_onunload;

  addButtonHandlers();
  textarea_onselectionchange();

  function addButtonHandlers() {
    var buttonsArray = document.getElementsByTagName('button');
    for (var i = 0; i < buttonsArray.length; i++) {
      addHandler(buttonsArray[i]);
    }

    function addHandler(btn) {
      btn.onmousedown = btn_onmousedown;
      btn.onmouseup = btn_mouseup;
      btn.onclick = btn_click;

      function btn_onmousedown(evt) {
        if (evt.preventDefault) evt.preventDefault();
        // TODO: apply 
      }

      function btn_mouseup(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }

      function btn_click(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }
    }
  }

  function getStorageText() {
    try {
      return localStorage.getItem('tty.wtf.content');
    } catch (error) {
      console.log('Browser failed to get data from localStorage. ', error);
    }
  }

  function setStorageText(text) {
    try {
      localStorage.setItem('tty.wtf.content', text);
      /** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess = true;
    } catch (error) {
      if (/** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess !== true)
        console.log('Browser failed to store data into localStorage. ', error);
      /** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess = false;
    }
  }

  function textarea_onchange() {
    clearTimeout(save_timeout);
    save_timeout = setTimeout(textarea_onchange_debounced, 600);
  }

  function textarea_onchange_debounced() {
    setStorageText(textarea.value);
    textarea_onselectionchange_debounced();
  }

  function textarea_onselectionchange() {
    clearTimeout(selection_timeout);
    selection_timeout = setTimeout(textarea_onselectionchange_debounced, 100);
  }

  function textarea_onselectionchange_debounced() {
    status.textContent = status.innerText = textarea.selectionStart + ':' + (textarea.selectionEnd - textarea.selectionStart);
    var modTextSection = getModifiersTextSection(textarea.value, textarea.selectionStart, textarea.selectionEnd);
    console.log({modTextSection: modTextSection});
  }

  function getModifiersTextSection(text, start, end) {
    var modText = text;
    if (start !== end) {
      modText = modText.slice(start, end);
      return { text: modText, start: start, end: end, modifiers: getModifiers(modText) };
    }

    /** @type {string} */
    var leadText;
    text.slice(0, start).replace(/\S\s*$/, str => leadText = str);
    var trailText;
    text.slice(0, start).replace(/^\s*\S/, str => trailText = str);

    if (trailText && !/\s/.test(trailText)) {
      modText = 
    }

    var mods = getModifiers(textarea.)
  }

  function window_onunload() {
    // save to local storage NOW
    textarea_onchange_debounced();
  }

  /** @param str {string} */
  function getModifiers(str) {
    var result = [];
    var resultQuickMap = {};
    for (var modKind in variants) {
      if (resultQuickMap[modKind]) continue;

      var rangeMap = variants[modKind];
      if (!rangeMap || typeof rangeMap !== 'object') continue;

      for (var rangeDescr in rangeMap) {
        /** @type {string[]} */
        var rangeList = rangeMap[rangeDescr];
        if (!rangeList || !(rangeList.length>0)) continue;

        for (var i = 0; i < rangeList.length; i++) {
          var rangeEntry = rangeList[i];

          if (str.indexOf(rangeEntry)>=0) {
            if (resultQuickMap[modKind]) break;
            resultQuickMap[modKind] = true;
            result.push(modKind);
          }
        }

        if (resultQuickMap[modKind]) break;
      }
    }

    // ensure if boldcursive is there, then both bold and cursive are also there
    for (var i = 0; i < result.length; i++) {
      if (result[i] !== 'bold' && /^bold/.test(result[i])) {
        if (result.indexOf('bold')<0) result.push('bold');
        var toAdd = result[i].slice(('bold').length);
        if (result.indexOf(toAdd)<0) result.push(toAdd);
      }
    }

    return result;
  }

  /** @param str {string} */
  function breakIntoChars(str) {
    /** @type {string[]} */
    var arr = [];
    str.replace(/./ug, function (ch) {
      arr.push(ch);
      return '';
    });
    return arr;
  }
}
window.onload = load;
</script>
</body>
</html>